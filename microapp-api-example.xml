<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="API Demo" scrolling="true">
    <Require feature="opensocial-templates"/>
    <Require feature="opensocial-data"/>
    <Require feature="views"/>
    <Require feature="dynamic-height"/>
	  <Require feature="osapi"/>
  </ModulePrefs>
  <Content type="html" view="home">
  <![CDATA[

    <script xmlns:os="http://ns.opensocial.org/2008/markup" type="text/os-data">
      /* here we can use data passed from the gadget to make an API call before the microapp is rendered. You must replace "your.sabacloud.com" with your site url. */
      <os:HttpRequest key="profile_data" href="https://dxc-itg-api.sabacloud.com/v1/people/${ViewParams.sabaContext.userId}:(socialProfile,coreProfile,lname,fname,email,is_manager,person_no,customValues)?SabaCertificate=${ViewParams.sabaContext.certificate}"/>
      <os:HttpRequest key="enrollments_data" href="https://dxc-itg-api.sabacloud.com/v1/enrollment?SabaCertificate=${ViewParams.sabaContext.certificate}"/>
      <os:HttpRequest key="transcript_data" href="https://dxc-itg-api.sabacloud.com/v1/transcripts?SabaCertificate=${ViewParams.sabaContext.certificate}"/>
	  /* Added by Shakeel for the Job Role data for testing */
     /*<os:HttpRequest key="jobrole_data" href="https://dxc-itg-api.sabacloud.com/v1/role/roles000000000003140?includeassociation=true&SabaCertificate=${ViewParams.sabaContext.apiCertificate}"/>*/
   </script>

    <style type="text/css">
      /* you could put a stylesheet in here too or link one in */
      /* you can also link in javascript as you would a regular web page rather than coding it inline */
    </style>
	<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'></script>
	
    <script type="text/javascript">

      function init(){
        var profileData = opensocial.data.DataContext.getDataSet('profile_data'), // these 3 lines bring in the variables from above containing the API data
            learningData = opensocial.data.DataContext.getDataSet('enrollments_data'),
            transData = opensocial.data.DataContext.getDataSet('transcript_data'),
            jobroleData = opensocial.data.DataContext.getDataSet('jobrole_data'), // Added by Shakeel for JobRole Data testing 
            viewData = gadgets.views.getParams(); //this brings in the ViewParams data passed from Saba
            //div1 = document.getElementById("1"),
            //div2 = document.getElementById("2"),
            //div3 = document.getElementById("3"),
            //div4 = document.getElementById("4"); // added by shakeel for Jobrole data testing
            //console.log(profileData.content.contact_email);
            //debug json data
            //console.log(viewData);
            //console.log(profileData);
      }
	  gadgets.util.registerOnLoadHandler(init);
	   var sabaCertificate = "4E41335431534E42303038312D333133363331363133333636333833363339333136363545323335453537353335463431343434443439344535453233354534453431333335343331353334453432333033303338333135453233354536353645354635353533354532333545353336313632363135453233354532443331354532333545323434313432343033303244303231343038383844314631324133433545323437424333363742353243313642423534353131463631333730323135303038304638444630353341383644414636334138423735343742444146424541394235463838464131";
       var employeeID = "emplo000000000104546";
       var userName = "22014213";
       var urlAPIRole = "https://dxc-itg-api.sabacloud.com/v1/";
	   
       var varRoleID;

       $(function () {       
			 $("#btnRoleSubmit").click(function () {                           
                submitGetRole();
			    $("#divRoleForm").css("display", "none");
                $("#divConfirmPreview").css("display", "block");
               
           });

           $("#btnRoleCancel").click(function () {
               document.getElementById("searchRoleParam").value = ""
           });

           $("#btnRoleBack").click(function () {
               $("#divConfirmPreview").css("display", "none");
               $("#divDeclinePreview").css("display", "block");

           });
		     $("#btnRoleConfrim").click(function () {		 
			 
                submitSetRoleInUserProfile();        
           });
		   
		    $("#btnCloseDecline").click(function () {
               
               $("#divConfirmPreview").css("display", "none");
               $("#divAffirmationAcknowledgement").css("display", "block");

           });

       });

          
           /* Call Role API to get the RoleID.   Satrt 
				Method GET, Input: Role Nmae
				OutPot: RoleID
		   */
	function submitGetRole() {
            var params = {};
            params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
            params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
            
            var inputParam = {};
            inputParam.name = $.trim($("[id*=searchRoleParam]").val());    
            var urlAPI = urlAPIRole + "role?q=(name==" + inputParam.name  + ")&SabaCertificate=" + sabaCertificate;
            gadgets.io.makeRequest(urlAPI, role2Response, params);
			document.getElementById("lbRoleID").innerHTML = inputParam.name;
        } 

        function role2Response(obj) {
            // Reference: https://developers.google.com/gadgets/docs/remote-content
            //  obj.data : <parsed data, if applicable>
            //  obj.errors : <any errors that occurred>
            //  obj.text : <raw text of the response>
            console.log(obj.data);
			console.log(obj.errors);
			console.log(obj.text);
			if (obj.data)
			{
				objJSON = JSON.parse(obj.data);
				var counter = objJSON.totalResults;
				for (j = 0 ; j < counter ; j++) {
                   				 roleId = objJSON.results[j].id
                   					//alert("roleID=" + roleId);
             					  }
			}
           		 		
			varRoleID = roleId;
			//alert("roleID=" + varRoleID);
			submitGetRoleDetails(varRoleID);
			if(obj.errors)
			{
			alert('Error in Role API Call')
				//$("#divAPIErrorMessage").css("display", "block");
                //$("#divConfirmPreview").css("display", "none");
                //$("#lbAPIError").html(JSON.stringify(obj.errors));
			}
        } 
		/* Call Role API to get the RoleID.   END  */
		/* Call Role API to get the Role Details.   Satrt 
				Method : Get, Input: RoleID
				OutPot: Skill; learningevent;associations
		*/
		function submitGetRoleDetails(roleID) {
            var params = {};
            params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
            params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
            
            var inputParam = {};
            //var url = urlAPIRole + "?q=(name==" + inputParam.name  + ")&SabaCertificate=" + sabaCertificate;
			//var urlAPIRoleDetails = urlAPIRole + '/' + roleID;
			var jobEmpSearchURLParam = urlAPIRole + "role/" + roleID+"?includeassociation=true&SabaCertificate=" + sabaCertificate;
			//alert(jobEmpSearchURLParam);
			gadgets.io.makeRequest(jobEmpSearchURLParam, roleDetail2Response, params);
        } 

        function roleDetail2Response(obj) {
            // Reference: https://developers.google.com/gadgets/docs/remote-content
            //  obj.data : <parsed data, if applicable>
            //  obj.errors : <any errors that occurred>
            //  obj.text : <raw text of the response>
            console.log(obj.data);
			console.log(obj.errors);
			console.log(obj.text);
			//alert(" Role Details  --- "+obj.data)
			if(obj.data)
			{
				jsonObj = JSON.parse(obj.data)
				data = '<table border="2"><tr><td><b>Object Name</b></td><td><b>Type</b></td></tr>';
			   var i = 0;
			   for (i = 0; i < jsonObj["associations"].learningevent.length; i++) {
				   obj = jsonObj["associations"].learningevent[i];
				   data = data + '<tr><td>' + obj.displayName + '</td><td>' + obj.type + '</td></tr>';
			   }
			   for (i = 0; i < jsonObj["associations"].skill.length; i++) {
				   obj = jsonObj["associations"].skill[i];
				   data = data + '<tr><td>' + obj.displayName + '</td><td>' + obj.minimumRequired + '</td></tr>';
			   }
				data += '</table>';
				//document.getElementById("divCourseDetails").innerHTML = data;
				$("#divCourseDetails").html(data);
			}
			
        } 
		
		/* Call Role API to get the Role Details.   END */
		/* Call Role API to SET the Role Details in user profile. Satrt  
			Method : Post; Input requiredJobRoles and Role ID with Employee ID.
			OutPut: EMPID and URL
		*/
		 
		function submitSetRoleInUserProfile() {
			//var postData12={"requiredJobRoles": [{"id": "roles000000000003140"}]};
			
			 var postDataRoleSet = {};
           postDataRoleSet.requiredJobRoles = [];
           postDataRoleSet.requiredJobRoles.unshift({});
           postDataRoleSet.requiredJobRoles[0]['id'] = varRoleID;
		   
			var headers = {};
			headers["Content-Type"] = "application/json";
			
            var params = {};
				//postdata = gadgets.io.encodeValues(postDataRoleSet);
				var postdata = gadgets.json.stringify(postDataRoleSet);
				console.log(postdata);
				//alert(postdata);
				params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
				params[gadgets.io.RequestParameters.POST_DATA] = postdata;	
				params[gadgets.io.RequestParameters.HEADERS] = headers;	

			var setRoleAPIURL = urlAPIRole + "people/" + employeeID + "/requiredjobrole?SabaCertificate=" + sabaCertificate;
			console.log(setRoleAPIURL);
				alert(setRoleAPIURL);
				gadgets.io.makeRequest(setRoleAPIURL, setRoleDetail2Response, params);
		} 
		
		 function setRoleDetail2Response(obj) {
            // Reference: https://developers.google.com/gadgets/docs/remote-content
            //  obj.data : <parsed data, if applicable>
            //  obj.errors : <any errors that occurred>
            //  obj.text : <raw text of the response>
            console.log(obj.data);
			console.log(obj.errors);
			console.log(obj.text);
			alert(obj.data +"**** Shakeel ***"+obj.errors+"**** Shakeel ***"+obj.text)
			if (obj.data){
				$("#divConfirmPreview").css("display", "none");
				$("#divAffirmationAcknowledgement").css("display", "block");
			}
			if(obj.errors){
				$("#divAPIErrorMessage").css("display", "block");
                $("#divConfirmPreview").css("display", "none");
                $("#lbAPIError").html(JSON.stringify(obj.errors));
			}
			
        } 
		/*Call Role API to SET the Role Details in user profile. END*/
		
    </script>

    <script type="text/os-template">
    <!-- Header of the Page Start -->
    
    <!-- Header of the Page END-->

    <!-- Search Box Start-->
    <div id="divRoleForm">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10" >
                    <tr>
                        <td align="center"  style="font-weight:bold;">
                                                    
                            Please Enter Your Initiative/ Progarm Code 3434343
			</td>
                    </tr>
                    <tr>                            
                            <td align="center" >
                                <input type="text" id="searchRoleParam" size="40">
                            </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnRoleSubmit" value="Submit">&nbsp;&nbsp;&nbsp;&nbsp;                                    
                                        <input type="button" id="btnRoleCancel" value="Cancel">
				 
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
    <!-- Search Box END-->

    <!-- Employee Confirms Previous Box Start-->
    <div id="divConfirmPreview" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">

                             <div id="divCourseDetails">

                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
									
									    <input type="button" id="btnRoleConfrim" value="Confirm">&nbsp;&nbsp;&nbsp;&nbsp;
										
                                        <input type="button" id="btnRoleBack" value="Back">
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
	<!-- Employee Confirms Previous Box END-->
	
	 <!-- Affirmation Acknowledgement Box Start-->
    <div id="divAffirmationAcknowledgement" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">
                            <p>
                                Congratulations On Starting The Journey To Become A Leader Of Technology Leader Of DXC’s Next Gen Business.  You Will Find The Related Learning Has Been Added To Your “My Learning” And The Related 	To “My Skills” "
                            </p>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnCloseDecline" value="Close">
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
    <!-- Affirmation Acknowledgement Box END-->
	
	<!-- User Declined Participation Box Start-->
    <div id="divDeclinePreview" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;"><p>
                                 Sorry You Could Not Participate At This Time.  If Later You Wish To Become A Technology Leader Of DXC’s Future Business You Can Do So By Selecting  “Me” and “Initiatives/Programs”.  Remember You Will Need Code "<label id="lbRoleID"></label>".                                  
                                </p>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnCloseDecline" value="Close">
                                        
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
    <!-- User Declined Participation Box END-->
     <!-- API Error Messgae Box Start-->
    <div id="divAPIErrorMessage" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">
                            <p>
                               Error: <label id="lbAPIError"></label>.
                            </p>
                        </td>
                    </tr>

                    <tr>
                        <td align="center">                           
                            <input type="button" id="btnCloseAPIError" value="Close">
                        </td>
                    </tr>
                </table>
            </center>

        </div>

    </div>
    <!-- API Error Messgae Box END-->
    </script>

  ]]>
  </Content>
</Module>
