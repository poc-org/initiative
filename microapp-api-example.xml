<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="API Demo" scrolling="true">
    <Require feature="opensocial-templates"/>
    <Require feature="opensocial-data"/>
    <Require feature="views"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html" view="home">
  <![CDATA[

    <script xmlns:os="http://ns.opensocial.org/2008/markup" type="text/os-data">
      /* here we can use data passed from the gadget to make an API call before the microapp is rendered. You must replace "your.sabacloud.com" with your site url. */

      <os:HttpRequest key="profile_data" href="https://dxc-itg-api.sabacloud.com/v1/people/${ViewParams.sabaContext.userId}:(socialProfile,coreProfile,lname,fname,email,is_manager,person_no,customValues)?SabaCertificate=${ViewParams.sabaContext.certificate}"/>

      <os:HttpRequest key="enrollments_data" href="https://dxc-itg-api.sabacloud.com/v1/enrollment?SabaCertificate=${ViewParams.sabaContext.certificate}"/>

      <os:HttpRequest key="transcript_data" href="https://dxc-itg-api.sabacloud.com/v1/transcripts?SabaCertificate=${ViewParams.sabaContext.certificate}"/>

/* Added by Shakeel for the Job Role data for testing */
     <os:HttpRequest key="jobrole_data" href="https://dxc-itg-api.sabacloud.com/v1/role/roles000000000003140?includeassociation=true&SabaCertificate=${ViewParams.sabaContext.apiCertificate}"/>
    </script>

    <style type="text/css">
      /* you could put a stylesheet in here too or link one in */

      /* you can also link in javascript as you would a regular web page rather than coding it inline */
    </style>
	<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'></script>
    <script type="text/javascript">

      function init(){
        var profileData = opensocial.data.DataContext.getDataSet('profile_data'), // these 3 lines bring in the variables from above containing the API data
            learningData = opensocial.data.DataContext.getDataSet('enrollments_data'),
            transData = opensocial.data.DataContext.getDataSet('transcript_data'),

            jobroleData = opensocial.data.DataContext.getDataSet('jobrole_data'), // Added by Shakeel for JobRole Data testing 
            viewData = gadgets.views.getParams(); //this brings in the ViewParams data passed from Saba
            //div1 = document.getElementById("1"),
            //div2 = document.getElementById("2"),
            //div3 = document.getElementById("3"),
            //div4 = document.getElementById("4"); // added by shakeel for Jobrole data testing

            //console.log(profileData.content.contact_email);
            //debug json data
            //console.log(viewData);
            //console.log(profileData);
      }
	  
 var sabaCertificate = "4E41335431534E42303038312D33313336333136313332333436333330333936323338354532333545353735333546343134343444343934453545323335453445343133333534333135333445343233303330333833313545323335453635364535463535353335453233354535333631363236313545323335453244333135453233354532343431343234303330324330323134374332333344364231333142313030323742323531333341383344453333433037423543353938333032313431324245414345443243463630423241373133343943433638364436394630443533323242384544";
       var employeeID = "emplo000000000104546";
       var userName = "22014213";
       var urlAPIRole = "https://dxc-itg-api.sabacloud.com/v1/role";
       var varRoleID;

       $(function () {       
			 $("#btnRoleSubmit").click(function () {
                           
               //var test =
                   //submitRoleQuery();
				   UserAction()
               //alert(test);
               //var test = OnSuccess(response, status);
               //alert(test+'Shakeel');
                //submitEmpProfileListQuery();

           });



           $("#btnRoleCancel").click(function () {
               document.getElementById("searchRoleParam").value = ""
           });

           $("#btnRoleBack").click(function () {
               divConfirmPreviou = document.getElementById('divConfirmPreviou');
               divConfirmPreviou.style.display = "none";

           });


       });

       function submitRoleQuery() {
           $("#result").empty();
           var inputParam = {};
           inputParam.name = $.trim($("[id*=searchRoleParam]").val());           
		   //alert(inputParam.name);
           jobRoleSearchURLParam = "q=(name==" + inputParam.name  + ")&SabaCertificate=" + sabaCertificate
		   alert(jobRoleSearchURLParam);
           var payLoad = ''

           $.ajax({
               type: "GET",
               url: urlAPIRole,
               data: jobRoleSearchURLParam,
               contentType: "application/json; charset=utf-8",   //contentType is for request
               //dataType: "json",   //datatype is for response, this has problem with base64 string; could be json, html, text, etc
               dataType: "text",
               success: OnSuccess,
               error: OnError

           });

       }
	   
	   function UserAction() {
			var xhttp = new XMLHttpRequest();
			alert('Test 123');
			xhttp.open("GET", "<os:HttpRequest key="jobrole_data" href="https://dxc-itg-api.sabacloud.com/v1/role?q=(name==eu2_role_test)&SabaCertificate=4E41335431534E42303038312D33313336333136313332333436333330333936323338354532333545353735333546343134343444343934453545323335453445343133333534333135333445343233303330333833313545323335453635364535463535353335453233354535333631363236313545323335453244333135453233354532343431343234303330324330323134374332333344364231333142313030323742323531333341383344453333433037423543353938333032313431324245414345443243463630423241373133343943433638364436394630443533323242384544"/>, true);
			xhttp.setRequestHeader("Content-type", "application/json");
			xhttp.send();
		   //var response = JSON.parse(xhttp.responseText);
		   alert(xhttp.responseText);
		   }

       //var roleId;
       function OnSuccess(response, status) {
           var roleId;
           //alert("success here")
           //alert(response);
           //var str = data.replace(/(?:\r\n|\r|\n)/g, '');
           obj = JSON.parse(response);
           var counter = obj.totalResults;
           // $("#result").append('<p class="textCounter">Number of results: ' + counter)
           //$("#result").append('<p></p>');
           //alert(counter);
               for (j = 0 ; j < counter ; j++) {
                    roleId = obj.results[j].id
                   //alert("roleID=" + roleId);
               }
              // alert("roleID=" + roleId);
               //varRoleID = roleId;
               //response = roleId;
               submitEmpProfileListQuery(roleId);
       }

       function OnError(request, status, error) {
           alert("error here");
           alert(JSON.stringify(request));
           alert(JSON.stringify(error));
           $("#lblData").html(request.statusText);
       }
       
      

       function submitEmpProfileListQuery(roleId) {
           $("#result").empty();           
           //var inputParam = {};          
           urlAPIEmpDetails = urlAPIRole + '/' + roleId;
          // alert(urlAPIEmpDetails);          
           //jobRoleSearchURLParam = "q=(name==" + inputParam.name + ")&33SabaCertificate=" + sabaCertificate
           jobEmpSearchURLParam = "includeassociation=true&SabaCertificate=" + sabaCertificate
           //alert(jobRoleSearchURLParam + '   Test SHakeel');
           
           var payLoad = ''

           $.ajax({
               type: "GET",
               url: urlAPIEmpDetails,
               data: jobEmpSearchURLParam,
               contentType: "application/json; charset=utf-8",   //contentType is for request
               //dataType: "json",   //datatype is for response, this has problem with base64 string; could be json, html, text, etc
               dataType: "text",
               success: OnSuccessEmpDetails,
               error: OnErrorEmpDetails

           });

       }


       function OnSuccessEmpDetails(response, status) {
           
           //alert("success here")
           alert(response);
           //var str = data.replace(/(?:\r\n|\r|\n)/g, '');
           //obj = JSON.parse(response);
           
           //if(response)
           //{
               
           //    var len = response.length;               
               
           //    var txt = "";
           //    if (len > 0) {
           //        for (var i = 0; i < len; i++) {
           //            if (response[i].displayName && response[i].type) {
           //                txt += "<tr><td>" + response[i].displayName + "</td><td>" + response[i].type + "</td></tr>";
           //            }
           //        }
                  
           //    }
           //}
           // $("#result").append('<p class="textCounter">Number of results: ' + counter)
           //$("#result").append('<p></p>');
           //alert(counter);
          // for (j = 0 ; j < counter ; j++) {
            //   roleId = obj.results[j].id
              // alert("roleID=" + roleId);
           //}

           //return roleId;
       }

       function OnErrorEmpDetails(request, status, error) {
           alert("error here");
           alert(JSON.stringify(request));
           alert(JSON.stringify(error));
           $("#lblData").html(request.statusText);
       }

      gadgets.util.registerOnLoadHandler(init);

    </script>

    <script type="text/os-template">
    <!-- Header of the Page Start -->
    
    <!-- Header of the Page END-->

    <!-- Search Box Start-->
    <div id="divRoleForm">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10" >
                    <tr>
                        <td align="center"  style="font-weight:bold;">
                                                    
                            Please Enter Your Initiative/ Progarm Code 2222
                        </td>
                    </tr>
                    <tr>                            
                            <td align="center" >
                                <input type="text" id="searchRoleParam" size="40">
                            </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnRoleSubmit" value="Submit">&nbsp;&nbsp;&nbsp;&nbsp;                                    
                                        <input type="button" id="btnRoleCancel" value="Cancel">
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
    <!-- Search Box Start-->

    <!-- Employee Confirms Previous Box Start-->
    <div id="divConfirmPreviou" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">

                            Profile Details
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnRoleConfrim" value="Confirm">&nbsp;&nbsp;&nbsp;&nbsp;
                                        <input type="button" id="btnRoleBack" value="Back">
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
    </script>

  ]]>
  </Content>
</Module>
