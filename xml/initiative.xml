<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="API Demo" scrolling="true">
    <Require feature="opensocial-templates"/>
    <Require feature="opensocial-data"/>
    <Require feature="views"/>
    <Require feature="dynamic-height"/>
    <Require feature="osapi"/>
  </ModulePrefs>
  <Content type="html" view="profile">
  <![CDATA[
  
	<!--<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'></script>-->
       <script src='../resource/js/jquery.min.js' type='text/javascript'></script>
       
	
    <script type="text/javascript" language="javascript">
		/* Global Varaibles Start */ 
		   var sabaCertificate ;
		   var employeeID ;
		   var userName ;
		   var urlAPIRole ;   
		   var varRoleID;
		   var  errorAPIRoleAssigmnet = "Insufficient Privileges: You do not have Can add required/optional role for self privilege on Person, Internal";
		   var varRoleDetailPDFlocation ;//= "https://raw.githubusercontent.com/poc-org/initiative/itg/doc/";
	   /* Global Varaibles END */ 
	   
        viewData = gadgets.views.getParams();   
	    sabaCertificate =  viewData.sabaContext.apiCertificate;
	    userName = $.trim(viewData.sabaContext.userName);
	    employeeID = $.trim(viewData.sabaContext.userId) ;
	    urlAPIRole =  $.trim(decodeURIComponent(viewData.sabaParams.saba_api_url))+'/v1/' ;
	   
   // gadgets.util.registerOnLoadHandler(init);
      function init(){
                   
            viewData = gadgets.views.getParams(); //this brings in the ViewParams data passed from Saba
      }
	  
	   
       
 
       $(function () {       
	    $("#btnRoleSubmit").click(function () {      
		  if ($.trim($("[id*=searchRoleParam]").val()) == "")
		       {
			   alert("Provide the Initiative/ Progarm Code");
			   return;
		       }
		  else{
                submitGetRegisteredRoleQuery();   
		      }
               
           });
           $("#btnRoleCancel").click(function () {
               document.getElementById("searchRoleParam").value = ""
           });
           $("#btnRoleBack").click(function () {
               $("#divRoleSkillListPreview").css("display", "none");
               $("#divPDFConfirmPreview").css("display", "block");
           });
           $("#btnRoleConfrim").click(function () {	
                submitSetRoleInUserProfile();        
           });   
          $("#btnCloseConfirmation").click(function () {               
               $("#divAffirmationAcknowledgement").css("display", "none");
               $("#divRoleForm").css("display", "block");
           });     
           $("#btnPDFEnroll").click(function () {               
               $("#divPDFConfirmPreview").css("display", "none");
               $("#divRoleSkillListPreview").css("display", "block");
           });
           $("#btnPDFDecline").click(function () {
               $("#divPDFConfirmPreview").css("display", "none");
               $("#divDeclinePreview").css("display", "block");
           });
           $("#btnBackToMain").click(function () {
               $("#divDeclinePreview").css("display", "none");
               $("#divRoleForm").css("display", "block");
           });
           $("#btnCloseAPIError").click(function () {
               $("#divAPIErrorMessage").css("display", "none");
               $("#divRoleForm").css("display", "block");
           });
  	   $("#btnBackToMainRole").click(function () {
               $("#divRegisteredRole").css("display", "none");
               $("#divRoleForm").css("display", "block");

           });
       });
          
           /* Call Role API to get the RoleID.   Start 
				Method GET, Input: Role Nmae
				OutPot: RoleID
		   */
	function submitGetRole() {
            var params = {};
            params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
            params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
            
            var inputParam = {};
            inputParam.name = $.trim($("[id*=searchRoleParam]").val());    
            var urlAPI = urlAPIRole + "role?q=(name==" + inputParam.name  + ")&SabaCertificate=" + sabaCertificate;
            gadgets.io.makeRequest(urlAPI, role2Response, params);
	    document.getElementById("lbRoleID").innerHTML = inputParam.name; 
        } 
        function role2Response(obj) {
           
			if (obj.data)
			{
				objJSON = JSON.parse(obj.data);
				var counter = objJSON.totalResults;
				if (counter>0)
				{
				for (j = 0 ; j < counter ; j++) {
                   				 roleId = objJSON.results[j].id
								 roleName = objJSON.results[j].name
               					  }
								 
				 
				 varRoleID = $.trim(roleId);
				 submitGetRolePDFFile(varRoleID) 
				 submitGetRoleDetails(varRoleID);
				 
				 $("#divPDFConfirmPreview").css("display", "block");
				 $("#divRoleForm").css("display", "none");
				}
				else
				{
					$("#divAPIErrorMessage").css("display", "block");
					$("#divRoleForm").css("display", "none");
					$("#lbAPIError").html("Sorry there is no such job role, make sure you entered right job code.");
				return;
				}
			}
			if($.trim(obj.errors))
			{
			
				$("#divAPIErrorMessage").css("display", "block");
                		$("#divRoleForm").css("display", "none");
               			 var jsonObj = JSON.parse(obj.text);	
			         $("#lbAPIError").html(jsonObj.errorMessage);
			}           	
			
        } 
		/* Call Role API to get the RoleID.   END  */
		
		/* Call ROle API to get the  registered Role to user profile.   Start
				Method : Get, Input: Employee Number
				OutPot: All registered Role 
		*/
		function submitGetRegisteredRoleQuery() {
			    var params = {};
			    params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
			    params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
alert("Api Call ");
			    var inputParam = {};
			    var urlAPIRoleList = urlAPIRole + 'people/' + employeeID + ':(requiredJobRoles)?SabaCertificate=' + sabaCertificate;
			   console.log(urlAPIRoleList);
			   gadgets.io.makeRequest(urlAPIRoleList, getRegisteredRole2Response, params);
				urlAPIRoleList ="";
      			  } 
        	function getRegisteredRole2Response(obj) {
			var strRoleFound = false;
            		if(obj.data)
			{
			alert("00000");
				roleJsonObj = JSON.parse(obj.data)
				data = '<table border="2"><tr><td><b>Registered Role</b></td></tr>';
			    var i = 0;
			alert(roleJsonObj.requiredJobRoles.length);
			alert(obj.text);
			    for (i = 0; i < roleJsonObj.requiredJobRoles.length; i++) {
                   	           objRole = roleJsonObj.requiredJobRoles[i];
				   data = data + '<tr><td>' + objRole.name + '</td></tr>';
				   alert(objRole.name +"1111");
			      if (($.trim(objRole.name)) == ($.trim($("[id*=searchRoleParam]").val())))
			  	      {
					alert(strRoleFound +"2222");
					      strRoleFound = true;
			   	       }
             		 	 }
			   
				data += '</table>';
				$("#divRegisteredRoleList").html(data);
				// checking the role exist in user profile or not Start 
				if (strRoleFound)
				   {
				
					   $("#divRoleForm").css("display", "none");
					   $("#divRegisteredRole").css("display", "block");
					   strRoleFound = false;
					   alert(strRoleFound  +"3333");
					   
				   }
				       else {
						alert(strRoleFound +"444");
					   submitGetRole();   // call the Role Details  funcation
				       }
              			 // checking the role exist in user profile or not END 
				 obj.data={};
			}
			
			if($.trim(obj.errors))
			{
			
				$("#divAPIErrorMessage").css("display", "block");
                	        $("#divRoleForm").css("display", "none");                
			        var jsonObj = JSON.parse(obj.text);	
			        $("#lbAPIError").html(jsonObj.errorMessage);
			}
        } 
/* Call ROle API to get the  registered Role to user profile.   END
		
		/* Call Role API to get the Role Details.   Start 
				Method : Get, Input: RoleID
				OutPot: Skill; learningevent;associations
		*/
		function submitGetRoleDetails(roleID) {
            var params = {};
            params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
            params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
            
            var inputParam = {};
            var jobEmpSearchURLParam = urlAPIRole + "role/" + roleID+"?includeassociation=true&SabaCertificate=" + sabaCertificate;
			gadgets.io.makeRequest(jobEmpSearchURLParam, roleDetail2Response, params);
        } 
        function roleDetail2Response(obj) {
            if(obj.data)
			{
				jsonObj = JSON.parse(obj.data)
				data = '<table border="2"><tr><td><b>Object Name</b></td><td><b>Type</b></td></tr>';
			   var i = 0;
			   for (i = 0; i < jsonObj["associations"].learningevent.length; i++) {
				   obj = jsonObj["associations"].learningevent[i];
				   data = data + '<tr><td>' + obj.displayName + '</td><td>' + obj.type + '</td></tr>';
			   }
			   for (i = 0; i < jsonObj["associations"].skill.length; i++) {
				   obj = jsonObj["associations"].skill[i];
				   data = data + '<tr><td>' + obj.displayName + '</td><td>' + obj.minimumRequired + '</td></tr>';
			   }
				data += '</table>';
				$("#divCourseDetails").html(data);
			}
			
        } 
				/* Call to Get the Role PDF File   END  */
		/* Call to Get the Role PDF File.   Start 
				Method : Get, Input: RoleID
				OutPot: PDF link of the Role 
		*/
		function submitGetRolePDFFile(roleID) {
            var params = {};
            params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
            params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
            
            var inputParam = {};            
			var varURLAPIRole = urlAPIRole + "attachments?ownerId=" + roleID +"&SabaCertificate=" + sabaCertificate
			gadgets.io.makeRequest(varURLAPIRole, rolePDFFile2Response, params);
        } 
        function rolePDFFile2Response(obj) {
            if(obj.data)
			{
		   var varResponce = obj.text.replace('["list",[', '');
                   varResponce = varResponce.replace(']]', '');
                   var jsonObj = JSON.parse(varResponce);
                   varRoleDetailPDFlocation = jsonObj.url
				 
		 if (varRoleDetailPDFlocation != "") {
                       var contentPDF = "<iframe width='100%' height='400px' frameborder='0' src=" + varRoleDetailPDFlocation + "><\/iframe>";
			        }
                  else {
                       var contentPDF = "<iframe width='100%' height='400px' frameborder='0' src=https://docs.google.com/viewer?url=https://test.com/test&embedded=true><\/iframe>";
                    }
                  
			}
			if($.trim(obj.errors)){
				var contentPDF = "<iframe width='100%' height='400px' frameborder='0' src=https://docs.google.com/viewer?url=https://test.com/test&embedded=true><\/iframe>";
				
			}
			document.getElementById("divPDFFrame").innerHTML = contentPDF;
			
        } 
		
		/* Call to Get the Role PDF File   END  */
		
		/* Call Role API to get the Role Details.   END */
		/* Call Role API to SET the Role Details in user profile. Start  
			Method : Post; Input requiredJobRoles and Role ID with Employee ID.
			OutPut: EMPID and URL
		*/
		 
		function submitSetRoleInUserProfile() {
				
			  var postDataRoleSet = {};
			   postDataRoleSet.requiredJobRoles = [];
			   postDataRoleSet.requiredJobRoles.unshift({});
			   postDataRoleSet.requiredJobRoles[0]['id'] = varRoleID;
		   
				var headers = {};
				headers["Content-Type"] = "application/json";			
                var params = {};
				
				var postdata = gadgets.json.stringify(postDataRoleSet);
				params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
				params[gadgets.io.RequestParameters.POST_DATA] = postdata;	
				params[gadgets.io.RequestParameters.HEADERS] = headers;	
			    var setRoleAPIURL = urlAPIRole + "people/" + employeeID + "/requiredjobrole?SabaCertificate=" + sabaCertificate;
                gadgets.io.makeRequest(setRoleAPIURL, setRoleDetail2Response, params);
				
		} 
		
		 function setRoleDetail2Response(obj) {
           	
			if (obj.data){
				$("#divRoleSkillListPreview").css("display", "none");
				$("#divAffirmationAcknowledgement").css("display", "block");
			}
			if($.trim(obj.errors)){
			     var jsonObj = JSON.parse(obj.text);	
			    $("#divAPIErrorMessage").css("display", "block");
                	    $("#divRoleSkillListPreview").css("display", "none");
                	    $("#lbAPIError").html(jsonObj.errorMessage);
				
			}
			
        } 
		/*Call Role API to SET the Role Details in user profile. END*/
		
    </script>
    <script type="text/os-template">
    <!-- Header of the Page Start -->
    
    <!-- Header of the Page END-->
    <!-- Search Box Start-->
<div  style="height:600px">
    <div id="divRoleForm">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10" >
                    <tr>
                        <td align="center"  style="font-weight:bold;">
                                                    
                            Please Enter Your Initiative/ Progarm Code  00000
			</td>
                    </tr>
                    <tr>                            
                            <td align="center" >
                                <input type="text" id="searchRoleParam" size="40">
                            </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnRoleSubmit" value="Submit">&nbsp;&nbsp;&nbsp;&nbsp;                                    
                                        <input type="button" id="btnRoleCancel" value="Cancel">
				 
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </center>
        </div>
    </div>
    <!-- Search Box END-->
	<!-- IF user alrady registed with the role need to show this block  Start-->
    <div id="divRegisteredRole" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">
                            <p>
                                Congratulations You Already Registered For This Role.
                            </p>

                            <div id="divRegisteredRoleList">

                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnBackToMainRole" value="Back">
                                    </td>
                                </tr>
                            </table>
                        </td>

                    </tr>
                </table>
            </center>

        </div>

    </div>
    <!-- IF user alrady registed with the role need to show this block  end-->
    <!-- PDF Overview Confirms Previous Box Start-->
    <div id="divPDFConfirmPreview" style="display:none" height="400px">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10" >
                    <tr>
                        <td align="center" style="font-weight:bold;" width="400px" height="400px">
                            <div id="divPDFFrame" ></div>
                            <!--<embed id="pdfRoleFile" src="" width="400px" height="200px" />-->
                            
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnPDFEnroll" value="Enroll">&nbsp;&nbsp;&nbsp;&nbsp;
                                        <input type="button" id="btnPDFDecline" value="Decline">
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </center>
        </div>
    </div>
    <!-- PDF Overview Confirms Previous Box END-->
    <!-- Employee Skill Role Confirms Previous Box Start-->
    <div id="divRoleSkillListPreview" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">
                             <div id="divCourseDetails">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
									
									    <input type="button" id="btnRoleConfrim" value="Confirm">&nbsp;&nbsp;&nbsp;&nbsp;
										
                                        <input type="button" id="btnRoleBack" value="Back">
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </center>
        </div>
    </div>
	<!-- Employee Skill Role Confirms Previous Box END-->
	
	 <!-- Affirmation Acknowledgement Box Start-->
    <div id="divAffirmationAcknowledgement" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">
                            <p>
                                Congratulations On Starting The Journey To Become A Leader Of Technology Leader Of DXC’s Next Gen Business.  You Will Find The Related Learning Has Been Added To Your “My Learning” And The Related 	To “My Skills” "
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnCloseConfirmation" value="Close">
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </center>
        </div>
    </div>
    <!-- Affirmation Acknowledgement Box END-->
	
	<!-- User Declined Participation Box Start-->
    <div id="divDeclinePreview" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;"><p>
                                 Sorry You Could Not Participate At This Time.  If Later You Wish To Become A Technology Leader Of DXC’s Future Business You Can Do So By Selecting  “Me” and “Initiatives/Programs”.  Remember You Will Need Code "<label id="lbRoleID"></label>".                                  
                                </p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table align="center">
                                <tr>
                                    <td align="center">
                                        <input type="button" id="btnBackToMain" value="Close">
                                        
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </center>
        </div>
    </div>
    <!-- User Declined Participation Box END-->
     <!-- API Error Messgae Box Start-->
    <div id="divAPIErrorMessage" style="display:none">
        <div>
            <center>
                <table border="10" cellpadding="10" cellspacing="10">
                    <tr>
                        <td align="center" style="font-weight:bold;">
                            <p>
                               Error: <label id="lbAPIError"></label>.
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td align="center">                           
                            <input type="button" id="btnCloseAPIError" value="Close">
                        </td>
                    </tr>
                </table>
            </center>
        </div>
    </div>
</div>
    <!-- API Error Messgae Box END-->
    </script>
  ]]>
  </Content>
</Module>
